<!DOCTYPE html>
<html>
<head>
    <script src="tinymce/tinymce.min.js"></script>
    <script src="popper/popper.min.js"></script>
    <script src="tippy/tippy-bundle.umd.min.js"></script>
    <link rel="stylesheet" href="tippy/scale.css">
    <script type="text/javascript">
        window.initOptions = {
            skin: "oxide",
            content_css: "default",
        };

        window.annotationInstances = null;
        window.labelInstances = null;

        const clearAnnotationTippys = function () {
            if (window.annotationInstances) {
                window.annotationInstances.forEach(e => e.destroy());
            }
            window.annotationInstances = null;
        };

        const setAnnotationTippys = function () {
            const doc = document.querySelector("iframe").contentDocument;
            window.annotationInstances = tippy(doc.querySelectorAll("annotation"), {
                arrow: false,
                placement: "right",
                offset: [40, 20],
            });
        };

        window.destroyFunction = function () {
            const bridge = window.bridgeObj;

            clearAnnotationTippys();

            if (tinymce.activeEditor) {
                tinymce.activeEditor.destroy();
            }
            bridge.setObjs(null);
            bridge.setInterfaceContent("");
        };

        window.initFunction = function (initContent) {
            window.destroyFunction();

            tinymce.init({
                selector: "#TinyMCEInstance",
                branding: false,
                menubar: false,
                resize: false,
                height: "100vh",

                skin: window.initOptions.skin,
                content_css: [
                    window.initOptions.content_css,
                    "com/yyil/noteapp/css/extra_styling.css",
                ],

                plugins: ["lists"],

                custom_elements: "~annotation",
                valid_children: "-annotation[annotation]",

                formats: {
                    annotation: {
                        inline: "annotation",
                        attributes: {
                            "data-tippy-content": "%value",
                        },
                        exact: true,
                        merge_siblings: false,
                    },
                },

                toolbar: `
                                undo redo |
                                styleselect |
                                bold italic underline strikethrough |
                                alignleft aligncenter alignright alignjustify |
                                bullist numlist outdent indent |
                                addAnnotateButton removeAnnotateButton labelButton
                            `,

                setup: function (ed) {
                    const bridge = window.bridgeObj;

                    const openAnnotateForm = function () {
                        if (ed.selection.getContent()) {
                            ed.fire("contexttoolbar-show", {
                                toolbarKey: "annotate-form",
                            });
                        }
                    };

                    const isRootAnnotation = function (node) {
                        return node ? node.nodeName.toLowerCase() === "annotation" : false;
                    };

                    const getAnnotationRoot = function (node) {
                        while (node && !isRootAnnotation(node)) {
                            node = node.parentNode;
                        }
                        return node;
                    };

                    const calcAnnotationPredicate = function (node) {
                        return getAnnotationRoot(node) ? true : false;
                    };

                    ed.on("init", function () {
                        // triggers SetContent event and updates interface content
                        ed.setContent(initContent);
                        bridge.setObjs(ed);
                    });

                    ed.on("Change SetContent", function (_) {
                        bridge.setInterfaceContent(ed.getContent());
                    });

                    ed.ui.registry.addButton("addAnnotateButton", {
                        icon: "edit-block",
                        tooltip: "Annotate",
                        onAction: function (_) {
                            openAnnotateForm();
                        },
                    });

                    ed.ui.registry.addButton("labelButton", {
                        icon: "character-count",
                        tooltip: "Label",
                        onAction: function (_) {
                            bridge.callModel("label", "");
                        },
                    });

                    ed.ui.registry.addContextForm("annotate-form", {
                        label: "Annotate",
                        initValue: function () {
                            var root = getAnnotationRoot(ed.selection.getNode());
                            return root ? root.getAttribute("data-tippy-content") : "";
                        },
                        position: "selection",
                        predicate: calcAnnotationPredicate,
                        commands: [
                            {
                                type: "contextformbutton",
                                icon: "checkmark",
                                tooltip: "Add",
                                primary: true,
                                onAction: function (formApi) {
                                    var value = formApi.getValue();
                                    if (value) {
                                        var root = getAnnotationRoot(ed.selection.getNode());
                                        if (!root) {
                                            for (k in ed.formatter.get()) {
                                                ed.formatter.remove(k);
                                            }
                                            ed.formatter.apply("annotation", { value: value });
                                        }
                                        else {
                                            root.setAttribute("data-tippy-content", value);
                                        }
                                        ed.fire("Change");
                                        clearAnnotationTippys();
                                        setAnnotationTippys();
                                    }
                                    formApi.hide();
                                },
                            },
                            {
                                type: "contextformbutton",
                                icon: "close",
                                tooltip: "Remove",
                                onAction: function (formApi) {
                                    var root = getAnnotationRoot(ed.selection.getNode());
                                    if (root) {
                                        root.removeAttribute("data-tippy-content");
                                        ed.formatter.remove("annotation", null, root);
                                    }
                                    ed.fire("Change");
                                    clearAnnotationTippys();
                                    setAnnotationTippys();
                                    formApi.hide();
                                },
                            },
                        ],
                    });
                },
            });
        };
    </script>
</head>
<body>
<form method="post">
    <textarea id="TinyMCEInstance"></textarea>
</form>
</body>
</html>

<style>
body {
    margin: 0px;
    height: 100vh;
}
</style>